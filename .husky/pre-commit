#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
STATUS=$?
if [ $STATUS -ne 0 ]; then
  echo "\nâŒ lint-staged failed. Commit aborted."
  exit 1
fi

echo "\nğŸ§ª Running TypeScript typecheck..."
npm run -s typecheck
STATUS=$?
if [ $STATUS -ne 0 ]; then
  echo "\nâŒ Typecheck failed. Commit aborted."
  exit 1
fi

# Secret scan with Gitleaks (optional locally, mandatory in CI)
if command -v gitleaks >/dev/null 2>&1; then
  echo "\nğŸ” Running Gitleaks pre-commit scan on staged changes..."
  gitleaks protect --staged --redact --config=.gitleaks.toml
  STATUS=$?
  if [ $STATUS -ne 0 ]; then
    echo "\nâŒ Gitleaks detected potential secrets. Commit aborted."
    echo "ğŸ‘‰ Review findings, remove secrets, rotate keys if needed, then commit again."
    exit 1
  fi
else
  echo "\nâš ï¸  Gitleaks not installed locally. Skipping local secret scan (CI will run it)."
  echo "   Install with: brew install gitleaks"
fi
